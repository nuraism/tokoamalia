<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profil - Toko Amalia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    .security-settings-section { /* */
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px dashed #ddd;
    }
    .security-settings-section h4 { /* */
      margin-bottom: 1rem;
      color: #333;
      font-size: 1.2rem;
    }
    /* CSS untuk menyembunyikan navigasi lain di halaman profil jika masih menggunakan pendekatan CSS murni */
    /* Jika sudah menggunakan setupFocusedNavigation, CSS ini mungkin tidak lagi dominan */
    /* header nav a:not(#navLinkProfil) {
        display: none !important; 
    } */
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="logo">
      <img src="avatar.png" alt="Logo">
      <span>Toko Amalia</span>
    </div>
    <nav>
      <a href="dashboard.html" id="navLinkDashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="produk.html?kategori=semua" id="navLinkProduk"><i class="fas fa-box"></i> Produk</a>
      <a href="transaksi.html" id="navLinkTransaksi"><i class="fas fa-cash-register"></i> Transaksi</a>
      <a href="penjualan.html" id="navLinkDataPenjualan"><i class="fas fa-file-invoice"></i> Data Penjualan</a>
      <a href="supplier.html" id="navLinkSupplier"><i class="fas fa-truck-loading"></i> Data Supplier</a>
      <a href="profil.html" id="navLinkProfil"><i class="fas fa-user"></i> Profil</a>
      <a href="tambah-produk.html" id="navLinkTambahProduk" class="admin-only-nav"><i class="fas fa-plus-circle"></i> Tambah Produk</a>
    </nav>
    <div class="logout-btn" onclick="logout()">
      <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </header>

  <main>
    <div class="header-section">
      <h2>Profil Toko & Pengguna</h2>
      <button onclick="window.location.href='dashboard.html'" class="back-button">
        <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
      </button>
    </div>
    
    <div class="profile-container">
      <div class="profile-info">
        <div class="profile-avatar">
          <img src="avatar.png" alt="Profil Toko">
          </div>
        
        <div class="profile-details">
          <h3 id="displayStoreName">Toko Amalia</h3>
          <p><i class="fas fa-map-marker-alt"></i> <span id="displayStoreAddress">Jl. Kepulauan Ayau</span></p>
          <p><i class="fas fa-phone"></i> <span id="displayStorePhone">085240934667</span></p>
          <p><i class="fas fa-envelope"></i> <span id="displayStoreEmail">suhernyibrahim@gmail.com</span></p>
          <p><i class="fas fa-clock"></i> Buka: <span id="displayOpenTime">07:00</span> - <span id="displayCloseTime">18:00</span> (Setiap Hari)</p>
          <p style="margin-top:1rem; font-weight:bold;">Pengguna: <span id="displayUsername" style="font-weight:normal;"></span></p>
        </div>
      </div>
      
      <div class="profile-form">
        <h3>Edit Profil Toko</h3>
        <form id="profile-form">
          <div class="form-group">
            <label for="store-name">Nama Toko</label>
            <input type="text" id="store-name" value="Toko Amalia">
          </div>
          
          <div class="form-group">
            <label for="store-address">Alamat</label>
            <textarea id="store-address">Jl. Kepulauan Ayau</textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="store-phone">Telepon</label>
              <input type="tel" id="store-phone" value="085240934667">
            </div>
            <div class="form-group">
              <label for="store-email">Email</label>
              <input type="email" id="store-email" value="suhernyibrahim@gmail.com">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="open-time">Jam Buka</label>
              <input type="time" id="open-time" value="07:00">
            </div>
            <div class="form-group">
              <label for="close-time">Jam Tutup</label>
              <input type="time" id="close-time" value="18:00">
            </div>
          </div>

          <div class="security-settings-section">
            <h4>Pengaturan Keamanan Akun (<span id="securityUsername"></span>)</h4>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 1rem;">Untuk mengubah pertanyaan keamanan, Anda harus memasukkan password Anda saat ini.</p>
            <div class="form-group">
              <label for="current-password">Password Saat Ini (wajib untuk ubah pertanyaan keamanan)</label>
              <input type="password" id="current-password" placeholder="Masukkan password Anda saat ini">
            </div>
            <div class="form-group">
              <label for="security-question">Pertanyaan Keamanan</label>
              <select id="security-question">
                <option value="">Pilih Pertanyaan Keamanan...</option>
                <option value="kota_lahir">Di kota mana Anda lahir?</option>
                <option value="nama_hewan">Siapa nama hewan peliharaan pertama Anda?</option>
                <option value="makanan_favorit">Apa makanan favorit Anda?</option>
              </select>
            </div>
            <div class="form-group">
              <label for="security-answer">Jawaban Keamanan Baru</label>
              <input type="text" id="security-answer" placeholder="Masukkan jawaban baru (jika ingin mengubah)">
            </div>
          </div>
          
          <button type="submit" class="save-button">
            <i class="fas fa-save"></i> Simpan Perubahan
          </button>
        </form>
      </div>
    </div>
  </main>

  <script>
    // --- Fungsi Navigasi Umum & Logout ---
    function setNavigationForRole(role) {
        const navLinks = {
            Produk: document.getElementById('navLinkProduk'),
            Transaksi: document.getElementById('navLinkTransaksi'),
            DataPenjualan: document.getElementById('navLinkDataPenjualan'),
            Supplier: document.getElementById('navLinkSupplier'),
            Profil: document.getElementById('navLinkProfil'),
            TambahProduk: document.getElementById('navLinkTambahProduk'),
            Dashboard: document.getElementById('navLinkDashboard')
        };
        if (navLinks.Dashboard) navLinks.Dashboard.style.display = 'flex';
        if (navLinks.Produk) navLinks.Produk.style.display = 'flex';
        if (navLinks.Profil) navLinks.Profil.style.display = 'flex';
        if (navLinks.Transaksi) navLinks.Transaksi.style.display = 'none';
        if (navLinks.DataPenjualan) navLinks.DataPenjualan.style.display = 'none';
        if (navLinks.Supplier) navLinks.Supplier.style.display = 'none';
        if (navLinks.TambahProduk) navLinks.TambahProduk.style.display = 'none';

        if (role === "admin") {
            if (navLinks.Transaksi) navLinks.Transaksi.style.display = 'flex';
            if (navLinks.DataPenjualan) navLinks.DataPenjualan.style.display = 'flex';
            if (navLinks.Supplier) navLinks.Supplier.style.display = 'flex';
            if (navLinks.TambahProduk) navLinks.TambahProduk.style.display = 'flex';
        } else if (role === "kasir") {
            if (navLinks.Transaksi) navLinks.Transaksi.style.display = 'flex';
        }
    }

    function setupFocusedNavigation(activeLinkId) {
        const header = document.getElementById('mainHeader');
        if (!header) return;
        const navElement = header.querySelector('nav');
        if (!navElement) return;
        const navLinks = navElement.querySelectorAll('a');
        navLinks.forEach(link => {
            if (link.id === activeLinkId) {
                if (link.style.display !== 'none') {
                    link.style.display = 'flex'; 
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            } else {
                link.style.display = 'none';
                link.classList.remove('active');
            }
        });
    }
    
    function logout() { //
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'index.html';
    }

    // --- Sisa kode JavaScript dari profil.html ---
    function simpleHash(str) { //
        let hash = 0;
        if (str.length === 0) return hash.toString();
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; 
        }
        return hash.toString();
    }
    
    function updateDisplayInfo(data) { //
        document.getElementById('displayStoreName').textContent = data.name || 'Toko Amalia';
        document.getElementById('displayStoreAddress').textContent = data.address || 'Jl. Kepulauan Ayau';
        document.getElementById('displayStorePhone').textContent = data.phone || '085240934667';
        document.getElementById('displayStoreEmail').textContent = data.email || 'suhernyibrahim@gmail.com';
        document.getElementById('displayOpenTime').textContent = data.openTime || '07:00';
        document.getElementById('displayCloseTime').textContent = data.closeTime || '18:00';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const username = localStorage.getItem('username');
      const role = localStorage.getItem('role');

      if (!isLoggedIn || isLoggedIn !== "true") {
        window.location.href = 'index.html';
        return;
      }
      
      setNavigationForRole(role); 
      setupFocusedNavigation('navLinkProfil'); // Fokus pada link Profil
      
      document.getElementById('displayUsername').textContent = username;
      document.getElementById('securityUsername').textContent = username;

      const storedStoreProfile = JSON.parse(localStorage.getItem('tokoAmaliaProfile'));
      if (storedStoreProfile) {
          document.getElementById('store-name').value = storedStoreProfile.name || 'Toko Amalia';
          document.getElementById('store-address').value = storedStoreProfile.address || 'Jl. Kepulauan Ayau';
          document.getElementById('store-phone').value = storedStoreProfile.phone || '085240934667';
          document.getElementById('store-email').value = storedStoreProfile.email || 'suhernyibrahim@gmail.com';
          document.getElementById('open-time').value = storedStoreProfile.openTime || '07:00';
          document.getElementById('close-time').value = storedStoreProfile.closeTime || '18:00';
          updateDisplayInfo(storedStoreProfile);
      } else {
        // Jika tidak ada profil tersimpan, tetap update display dengan nilai default
        updateDisplayInfo({});
      }

      const userDataString = localStorage.getItem(username);
      if (userDataString) {
          const userData = JSON.parse(userDataString);
          if (userData.securityQuestion) {
              document.getElementById('security-question').value = userData.securityQuestion;
          }
      }
      
      document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const storeData = {
          name: document.getElementById('store-name').value,
          address: document.getElementById('store-address').value,
          phone: document.getElementById('store-phone').value,
          email: document.getElementById('store-email').value,
          openTime: document.getElementById('open-time').value,
          closeTime: document.getElementById('close-time').value
        };
        localStorage.setItem('tokoAmaliaProfile', JSON.stringify(storeData));
        updateDisplayInfo(storeData);
        
        const currentPassword = document.getElementById('current-password').value;
        const newSecurityQuestion = document.getElementById('security-question').value;
        const newSecurityAnswer = document.getElementById('security-answer').value.trim();
        const username = localStorage.getItem('username');
        let securityUpdated = false;

        if (newSecurityQuestion && newSecurityAnswer) {
          if (!currentPassword) {
            alert('Password saat ini wajib diisi untuk mengubah pertanyaan keamanan!');
            return;
          }
          const userDataString = localStorage.getItem(username);
          if (!userDataString) {
            alert('Data pengguna tidak ditemukan!');
            return;
          }
          let userData = JSON.parse(userDataString);
          if (simpleHash(currentPassword) !== userData.passwordHash) {
            alert('Password saat ini salah!');
            return;
          }
          userData.securityQuestion = newSecurityQuestion;
          userData.securityAnswerHash = simpleHash(newSecurityAnswer.toLowerCase());
          localStorage.setItem(username, JSON.stringify(userData));
          securityUpdated = true;
        } else if ((newSecurityQuestion && !newSecurityAnswer) || (!newSecurityQuestion && newSecurityAnswer)) {
           if (newSecurityQuestion && !newSecurityAnswer && document.getElementById('security-question').value !== "") {
              alert('Jika memilih pertanyaan keamanan baru, jawaban keamanan baru juga harus diisi.');
              return;
           }
        }
        let alertMessage = 'Profil toko berhasil diperbarui!';
        if (securityUpdated) {
            alertMessage += '\nPertanyaan keamanan berhasil diperbarui.';
        }
        alert(alertMessage);
        document.getElementById('current-password').value = '';
        document.getElementById('security-answer').value = '';
      });
    });
  </script>
</body>
</html>