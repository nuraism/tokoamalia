<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produk - Toko Amalia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    .product-id { 
        margin-bottom: 0.5rem;
        color: #555;
        font-size: 0.9em;
    }
    .admin-actions button {
        color: white; 
        border: none; 
        padding: 0.6rem 1rem; 
        border-radius: 5px; 
        cursor: pointer; 
        margin-top: 0.5rem; 
        width: calc(50% - 5px); /* Adjust width for two buttons */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
        transition: background-color 0.2s ease;
        margin-right: 5px; /* Spacing between buttons */
    }
    .admin-actions button:last-child {
        margin-right: 0;
    }
    .edit-btn {
        background: #ffc107; 
    }
    .edit-btn:hover {
        background: #e0a800;
    }
    .delete-btn {
        background: #dc3545; /* Red color for delete */
    }
    .delete-btn:hover {
        background: #c82333;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="avatar.png" alt="Logo">
      <span>Toko Amalia</span>
    </div>
    <nav>
      <a href="#" class="active" id="navLinkProduk"><i class="fas fa-box"></i> Produk</a>
      <a href="transaksi.html" id="navLinkTransaksi"><i class="fas fa-cash-register"></i> Transaksi</a>
      <a href="penjualan.html" id="navLinkDataPenjualan" style="display:none;"><i class="fas fa-file-invoice"></i> Data Penjualan</a>
      <a href="profil.html" id="navLinkProfil"><i class="fas fa-user"></i> Profil</a>
      <a href="tambah-produk.html" id="navLinkTambahProduk" class="admin-only-nav" style="display:none;"><i class="fas fa-plus-circle"></i> Tambah Produk</a>
    </nav>
     <div class="logout-btn" onclick="logout()"> <i class="fas fa-sign-out-alt"></i> Logout
    </div>
  </header>

  <main>
    <div class="header-section">
      <h2 id="kategori-title">Bahan Pokok</h2>
      <button onclick="window.location.href='dashboard.html'" class="back-button">
        <i class="fas fa-arrow-left"></i> Kembali ke Dashboard
      </button>
    </div>
    
    <div class="products-container" id="products-list">
      </div>
  </main>

  <script>
    function setNavigationForRole(role) {
        const navLinkDataPenjualan = document.getElementById('navLinkDataPenjualan');
        const navLinkTambahProduk = document.getElementById('navLinkTambahProduk');

        if(navLinkDataPenjualan) navLinkDataPenjualan.style.display = 'none';
        if(navLinkTambahProduk) navLinkTambahProduk.style.display = 'none';

        if (role === "admin") {
            if(navLinkDataPenjualan) navLinkDataPenjualan.style.display = 'flex';
            if(navLinkTambahProduk) navLinkTambahProduk.style.display = 'flex';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const isLoggedIn = localStorage.getItem('isLoggedIn');
        const role = localStorage.getItem('role');

        if (!isLoggedIn || isLoggedIn !== "true") {
            window.location.href = 'index.html';
            return; 
        }
        
        setNavigationForRole(role); 
        loadAndDisplayProducts();
    });
    
    function logout() { 
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('username');
      localStorage.removeItem('role');
      window.location.href = 'index.html';
    }

    const produkDatabaseDefault = { /* Same as your provided data */
          'bahan-pokok': [
            { id: "bp001", nama: "99 20kg", harga: 350000, stok: 10, gambar: "99.png" },
            { id: "bp002", nama: "Mi-Won 250gr", harga: 8000, stok: 24, gambar: "miwon.png" },
            { id: "bp003", nama: "Garam 500gr", harga: 8000, stok: 48, gambar: "garam.png" },
            { id: "bp004", nama: "Kopi senang 250gr", harga: 22000, stok: 50, gambar: "kopi.png" },
            { id: "bp005", nama: "Kunci Mas 1L", harga: 20000, stok: 12, gambar: "kc.png" },
            { id: "bp006", nama: "Gula pasir 1kg", harga: 20000, stok: 50, gambar: "gula.png" },
            { id: "bp007", nama: "Garam 250gr", harga: 5000, stok: 25, gambar: "garam.png" },
            { id: "bp008", nama: "Mi-Won 500gr", harga: 15000, stok: 10, gambar: "miwon.png" },
            { id: "bp009", nama: "Kunci Mas 2L", harga: 40000, stok: 12, gambar: "kc.png" },
            { id: "bp010", nama: "Merpati 17kg", harga: 275000, stok: 10, gambar: "merpati.png" },
            { id: "bp011", nama: "Karung Kuning 10kg", harga: 150000, stok: 10, gambar: "karungkuning.png" },
            { id: "bp012", nama: "Padi Udang 20kg", harga: 355000, stok: 10, gambar: "padiudang.png" }
          ],
          'makanan': [
            { id: "ma013", nama: "Hatari Cocopuff", harga: 8000, stok: 11, gambar: "hatari.png" },
            { id: "ma014", nama: "Malkits Crackers", harga: 8000, stok: 16, gambar: "malkits.png" },
            { id: "ma015", nama: "Saltcheese", harga: 12000, stok: 24, gambar: "salt.png" },
            { id: "ma016", nama: "Sari Gandum", harga: 12000, stok: 24, gambar: "sarigandum.png" },
            { id: "ma017", nama: "Kusuka", harga: 8000, stok: 32, gambar: "kusuka.png" },
            { id: "ma018", nama: "Fullo Coklat", harga: 15000, stok: 10, gambar: "Fullo.png" },
            { id: "ma019", nama: "Kopiko", harga: 10000, stok: 24, gambar: "kopiko.png" },
            { id: "ma020", nama: "Hatari peanut", harga: 8000, stok: 32, gambar: "peanut.png" },
            { id: "ma021", nama: "Superco", harga: 10000, stok: 24, gambar: "superco.png" },
            { id: "ma022", nama: "Malkits Coklat", harga: 8000, stok: 18, gambar: "malkits2.png" }
          ],
          'minuman': [
            { id: "mi023", nama: "Aqua 600ml", harga: 5000, stok: 13, gambar: "aqua.png" },
            { id: "mi024", nama: "Teh Pucuk 350ml", harga: 5000, stok: 35, gambar: "tehpucuk.png" },
            { id: "mi025", nama: "Mizone 500ml", harga: 8000, stok: 20, gambar: "mizone.png" },
            { id: "mi026", nama: "Fanta 250ml", harga: 7000, stok: 20, gambar: "fanta.png" },
            { id: "mi027", nama: "Coca cola 250ml", harga: 7000, stok: 20, gambar: "cocacola.png" },
            { id: "mi028", nama: "Sprite", harga: 7000, stok: 20, gambar: "sprite.png" },
            { id: "mi029", nama: "Nestle 600ml", harga: 5000, stok: 20, gambar: "nestle.png" },
            { id: "mi030", nama: "Aqua 1500ml", harga: 10000, stok: 20, gambar: "aqua.png" },
            { id: "mi031", nama: "Nestle 1500ml", harga: 10000, stok: 20, gambar: "nestle.png" }
          ]
        };

    function deleteProduct(productId, productName, productCategory) {
        if (!confirm(`Apakah Anda yakin ingin menghapus produk "${productName}" (ID: ${productId})?`)) {
            return;
        }

        let customProducts = JSON.parse(localStorage.getItem('customProducts')) || [];
        const existingCustomIndex = customProducts.findIndex(p => p.id === productId);

        if (existingCustomIndex !== -1) {
            // Product exists in customProducts, remove it directly
            customProducts.splice(existingCustomIndex, 1);
        } else {
            // Product is a default product, not yet in customProducts.
            // Add it to customProducts with stok 0 to mark as "deleted" from default.
            let productToDeleteFromDefault = null;
            if (produkDatabaseDefault[productCategory]) {
                 productToDeleteFromDefault = produkDatabaseDefault[productCategory].find(p => p.id === productId);
            }
            
            if (productToDeleteFromDefault) {
                customProducts.push({ ...productToDeleteFromDefault, stok: 0, isDeleted: true }); // Mark as deleted
            } else {
                // Fallback: if somehow not found in default (should not happen if category is correct)
                // This case means it's a product not in default and not in custom - so nothing to delete actually.
                // However, the button would only appear if the product is displayed.
                alert("Produk tidak ditemukan untuk dihapus (mungkin sudah dihapus atau ID salah).");
                loadAndDisplayProducts(); // Refresh list
                return;
            }
        }

        localStorage.setItem('customProducts', JSON.stringify(customProducts));
        alert(`Produk "${productName}" berhasil dihapus.`);
        loadAndDisplayProducts(); // Refresh list
    }


    function loadAndDisplayProducts() {
        const urlParams = new URLSearchParams(window.location.search);
        const kategoriDariUrl = urlParams.get('kategori') || 'bahan-pokok';
        
        let produkUntukDitampilkan = []; 

        try {
            const customProducts = JSON.parse(localStorage.getItem('customProducts')) || [];
            
            let semuaProdukDefaultFlat = [];
            Object.keys(produkDatabaseDefault).forEach(catKey => {
                produkDatabaseDefault[catKey].forEach(p => {
                    semuaProdukDefaultFlat.push({...p, kategori: catKey, isCustom: false});
                });
            });

            let mergedProduk = [];
            semuaProdukDefaultFlat.forEach(defaultP => {
                const customVersion = customProducts.find(cp => cp.id === defaultP.id);
                if (customVersion) {
                    // If custom version exists and is marked deleted or has 0 stock (due to previous deletion)
                    // and we don't want to show deleted items, we skip it.
                    // Otherwise, take the custom version.
                    if (!(customVersion.isDeleted || customVersion.stok <= 0)) {
                         mergedProduk.push({...defaultP, ...customVersion, isCustom: true});
                    }
                } else {
                    // If no custom version, take the default
                    mergedProduk.push(defaultP);
                }
            });

            // Add any purely custom products (not overriding defaults) that aren't marked deleted
            customProducts.forEach(customP => {
                if (!mergedProduk.some(mp => mp.id === customP.id)) {
                    if (!(customP.isDeleted || customP.stok <=0)) {
                        mergedProduk.push({...customP, isCustom: true});
                    }
                }
            });
            
            if (produkDatabaseDefault[kategoriDariUrl] || kategoriDariUrl === 'semua') { 
                if (kategoriDariUrl === 'semua') {
                    produkUntukDitampilkan = mergedProduk.filter(p => !(p.isDeleted || p.stok <= 0));
                } else {
                    produkUntukDitampilkan = mergedProduk.filter(p => p.kategori === kategoriDariUrl && !(p.isDeleted || p.stok <= 0));
                }
            } else { 
                 produkUntukDitampilkan = mergedProduk.filter(p => p.kategori === kategoriDariUrl && !(p.isDeleted || p.stok <= 0));
            }

        } catch (error) {
            console.error("Gagal memuat produk kustom dari localStorage:", error);
            if (produkDatabaseDefault[kategoriDariUrl]) {
                produkUntukDitampilkan = [...produkDatabaseDefault[kategoriDariUrl]];
            }
        }

        const kategoriTitles = {
          'bahan-pokok': 'Bahan Pokok',
          'makanan': 'Makanan',
          'minuman': 'Minuman',
          'semua': 'Semua Produk' // Added for potential "all" category view
        };
        document.getElementById('kategori-title').textContent = kategoriTitles[kategoriDariUrl] || 'Daftar Produk';

        const productsContainer = document.getElementById('products-list');
        productsContainer.innerHTML = ''; 
        
        if (produkUntukDitampilkan.length === 0) {
            productsContainer.innerHTML = '<div class="no-products" style="text-align:center; color: #777; padding: 2rem 0;">Tidak ada produk dalam kategori ini.</div>';
            return;
        }

        const userRole = localStorage.getItem('role');

        produkUntukDitampilkan.forEach(produk => {
          const productCard = document.createElement('div');
          productCard.className = 'product-card';
          let adminActionsHtml = '';
          if (userRole === 'admin') {
              adminActionsHtml = `
                <div class="admin-actions">
                    <button class="edit-btn" onclick="window.location.href='edit-barang.html?id=${produk.id}&kategori=${produk.kategori}'"><i class="fas fa-edit"></i> Edit</button>
                    <button class="delete-btn" onclick="deleteProduct('${produk.id}', '${produk.nama.replace(/'/g, "\\'")}', '${produk.kategori}')"><i class="fas fa-trash"></i> Hapus</button>
                </div>`;
          }

          productCard.innerHTML = `
            <img src="${produk.gambar || 'placeholder.png'}" alt="${produk.nama}" onerror="this.onerror=null;this.src='placeholder.png';">
            <h3>${produk.nama}</h3>
            <p class="product-id">ID: ${produk.id}</p>
            <div class="product-info">
              <span>Rp${produk.harga.toLocaleString('id-ID')}</span>
              <span>Stok: ${produk.stok}</span>
            </div>
            ${adminActionsHtml}
          `;
          productsContainer.appendChild(productCard);
        });
    }
  </script>
</body>
</html>